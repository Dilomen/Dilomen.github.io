<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>概述 | DILOMEN&#39;S BLOG</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="shortcut icon" href="/logo.ico" type="images/x-icon">
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.slim.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content=" ">
    <meta name="keywords" content="前端博客,前端进阶,前端学习分享,web前端技术,前端进阶">
    <meta name="baidu-site-verification" content="1habgJadYO">
    
    <link rel="preload" href="/assets/css/0.styles.a21ae05c.css" as="style"><link rel="preload" href="/assets/js/app.42f00aa1.js" as="script"><link rel="preload" href="/assets/js/2.edb9f13a.js" as="script"><link rel="preload" href="/assets/js/102.6d1fffe1.js" as="script"><link rel="preload" href="/assets/js/3.61a7e294.js" as="script"><link rel="prefetch" href="/assets/js/10.3e83a25e.js"><link rel="prefetch" href="/assets/js/100.28dbeddf.js"><link rel="prefetch" href="/assets/js/101.c40012a4.js"><link rel="prefetch" href="/assets/js/103.98284151.js"><link rel="prefetch" href="/assets/js/104.24b66762.js"><link rel="prefetch" href="/assets/js/105.cf54b610.js"><link rel="prefetch" href="/assets/js/106.0be9b77e.js"><link rel="prefetch" href="/assets/js/107.ae633409.js"><link rel="prefetch" href="/assets/js/108.af7742e1.js"><link rel="prefetch" href="/assets/js/109.e132bc9e.js"><link rel="prefetch" href="/assets/js/11.37429034.js"><link rel="prefetch" href="/assets/js/110.0f916d0e.js"><link rel="prefetch" href="/assets/js/111.bb41bda2.js"><link rel="prefetch" href="/assets/js/112.541c20af.js"><link rel="prefetch" href="/assets/js/113.bd18de3d.js"><link rel="prefetch" href="/assets/js/114.2b3f5745.js"><link rel="prefetch" href="/assets/js/115.4389e2b1.js"><link rel="prefetch" href="/assets/js/116.c80d48d1.js"><link rel="prefetch" href="/assets/js/117.823b361c.js"><link rel="prefetch" href="/assets/js/118.d3dea1a4.js"><link rel="prefetch" href="/assets/js/119.7283d4e2.js"><link rel="prefetch" href="/assets/js/12.51e0741f.js"><link rel="prefetch" href="/assets/js/120.209094e0.js"><link rel="prefetch" href="/assets/js/121.25afaf69.js"><link rel="prefetch" href="/assets/js/122.fe110abc.js"><link rel="prefetch" href="/assets/js/123.92da54b4.js"><link rel="prefetch" href="/assets/js/124.3f9e73bd.js"><link rel="prefetch" href="/assets/js/125.b0ffb6ed.js"><link rel="prefetch" href="/assets/js/126.b93cd35b.js"><link rel="prefetch" href="/assets/js/127.f31ab3ea.js"><link rel="prefetch" href="/assets/js/128.7d69a18a.js"><link rel="prefetch" href="/assets/js/129.2be82451.js"><link rel="prefetch" href="/assets/js/13.3895f524.js"><link rel="prefetch" href="/assets/js/130.8b3e02e8.js"><link rel="prefetch" href="/assets/js/131.ec472deb.js"><link rel="prefetch" href="/assets/js/132.96300569.js"><link rel="prefetch" href="/assets/js/133.39f1bbad.js"><link rel="prefetch" href="/assets/js/134.3e2a512b.js"><link rel="prefetch" href="/assets/js/135.9a57c728.js"><link rel="prefetch" href="/assets/js/136.1dd80cdf.js"><link rel="prefetch" href="/assets/js/137.52dd46ee.js"><link rel="prefetch" href="/assets/js/138.11f14aa5.js"><link rel="prefetch" href="/assets/js/139.cfbcfb81.js"><link rel="prefetch" href="/assets/js/14.45d47193.js"><link rel="prefetch" href="/assets/js/140.425a15fe.js"><link rel="prefetch" href="/assets/js/141.f9849b24.js"><link rel="prefetch" href="/assets/js/142.8a1139d0.js"><link rel="prefetch" href="/assets/js/143.7529486e.js"><link rel="prefetch" href="/assets/js/144.5c29b468.js"><link rel="prefetch" href="/assets/js/145.1ae96e29.js"><link rel="prefetch" href="/assets/js/146.6f822034.js"><link rel="prefetch" href="/assets/js/147.5c508ce8.js"><link rel="prefetch" href="/assets/js/148.ee4e4cc2.js"><link rel="prefetch" href="/assets/js/149.58ecc512.js"><link rel="prefetch" href="/assets/js/15.3567bb95.js"><link rel="prefetch" href="/assets/js/150.39f8fce3.js"><link rel="prefetch" href="/assets/js/151.2825d286.js"><link rel="prefetch" href="/assets/js/152.2da8e865.js"><link rel="prefetch" href="/assets/js/153.86a81593.js"><link rel="prefetch" href="/assets/js/154.119e0e7e.js"><link rel="prefetch" href="/assets/js/155.022299a9.js"><link rel="prefetch" href="/assets/js/156.d4df2e10.js"><link rel="prefetch" href="/assets/js/157.4a6181ce.js"><link rel="prefetch" href="/assets/js/158.af5bddfc.js"><link rel="prefetch" href="/assets/js/159.eeb2c9e6.js"><link rel="prefetch" href="/assets/js/16.36a3a351.js"><link rel="prefetch" href="/assets/js/160.70206dcf.js"><link rel="prefetch" href="/assets/js/161.6044f2e0.js"><link rel="prefetch" href="/assets/js/162.989382a2.js"><link rel="prefetch" href="/assets/js/163.da6b4f61.js"><link rel="prefetch" href="/assets/js/164.2a8b67a4.js"><link rel="prefetch" href="/assets/js/165.3989ca70.js"><link rel="prefetch" href="/assets/js/166.ab313e43.js"><link rel="prefetch" href="/assets/js/167.58a63a9e.js"><link rel="prefetch" href="/assets/js/168.f4f52a23.js"><link rel="prefetch" href="/assets/js/169.4acfc055.js"><link rel="prefetch" href="/assets/js/17.4d809ce3.js"><link rel="prefetch" href="/assets/js/170.8eda8934.js"><link rel="prefetch" href="/assets/js/171.2313ddff.js"><link rel="prefetch" href="/assets/js/172.24da8926.js"><link rel="prefetch" href="/assets/js/173.a55d7677.js"><link rel="prefetch" href="/assets/js/174.2ea1853c.js"><link rel="prefetch" href="/assets/js/175.9c2b105a.js"><link rel="prefetch" href="/assets/js/18.a7a91cac.js"><link rel="prefetch" href="/assets/js/19.04f964bb.js"><link rel="prefetch" href="/assets/js/20.b6d8a7c3.js"><link rel="prefetch" href="/assets/js/21.149e098c.js"><link rel="prefetch" href="/assets/js/22.c3acf1a5.js"><link rel="prefetch" href="/assets/js/23.f0d4ea40.js"><link rel="prefetch" href="/assets/js/24.6c98f948.js"><link rel="prefetch" href="/assets/js/25.d3f6c4b1.js"><link rel="prefetch" href="/assets/js/26.80d61efb.js"><link rel="prefetch" href="/assets/js/27.88c44748.js"><link rel="prefetch" href="/assets/js/28.dfb49e22.js"><link rel="prefetch" href="/assets/js/29.aaf2bc24.js"><link rel="prefetch" href="/assets/js/30.a539f221.js"><link rel="prefetch" href="/assets/js/31.7eec0158.js"><link rel="prefetch" href="/assets/js/32.c4778059.js"><link rel="prefetch" href="/assets/js/33.b0309fb7.js"><link rel="prefetch" href="/assets/js/34.05f5835f.js"><link rel="prefetch" href="/assets/js/35.9d133d1b.js"><link rel="prefetch" href="/assets/js/36.30d81f99.js"><link rel="prefetch" href="/assets/js/37.4ec929f8.js"><link rel="prefetch" href="/assets/js/38.3899d039.js"><link rel="prefetch" href="/assets/js/39.b5a4fc4f.js"><link rel="prefetch" href="/assets/js/4.3b8adb0a.js"><link rel="prefetch" href="/assets/js/40.896127a9.js"><link rel="prefetch" href="/assets/js/41.a8b59a21.js"><link rel="prefetch" href="/assets/js/42.d8b68479.js"><link rel="prefetch" href="/assets/js/43.539d377f.js"><link rel="prefetch" href="/assets/js/44.b25c02db.js"><link rel="prefetch" href="/assets/js/45.b4563026.js"><link rel="prefetch" href="/assets/js/46.829a8bf2.js"><link rel="prefetch" href="/assets/js/47.59d38e5b.js"><link rel="prefetch" href="/assets/js/48.8be081d8.js"><link rel="prefetch" href="/assets/js/49.a08f1830.js"><link rel="prefetch" href="/assets/js/5.49aa2835.js"><link rel="prefetch" href="/assets/js/50.62c6483e.js"><link rel="prefetch" href="/assets/js/51.a30179ca.js"><link rel="prefetch" href="/assets/js/52.22c37887.js"><link rel="prefetch" href="/assets/js/53.899c56f7.js"><link rel="prefetch" href="/assets/js/54.3a0102f8.js"><link rel="prefetch" href="/assets/js/55.6cd2f68f.js"><link rel="prefetch" href="/assets/js/56.7f328803.js"><link rel="prefetch" href="/assets/js/57.8f1e329a.js"><link rel="prefetch" href="/assets/js/58.735913d8.js"><link rel="prefetch" href="/assets/js/59.65a165bd.js"><link rel="prefetch" href="/assets/js/6.b541305f.js"><link rel="prefetch" href="/assets/js/60.5e2afdd3.js"><link rel="prefetch" href="/assets/js/61.70659dd2.js"><link rel="prefetch" href="/assets/js/62.cd71fd02.js"><link rel="prefetch" href="/assets/js/63.542e747d.js"><link rel="prefetch" href="/assets/js/64.6029712d.js"><link rel="prefetch" href="/assets/js/65.6d904154.js"><link rel="prefetch" href="/assets/js/66.73003587.js"><link rel="prefetch" href="/assets/js/67.31cc557b.js"><link rel="prefetch" href="/assets/js/68.a0131337.js"><link rel="prefetch" href="/assets/js/69.b94678ce.js"><link rel="prefetch" href="/assets/js/7.fabce998.js"><link rel="prefetch" href="/assets/js/70.70175176.js"><link rel="prefetch" href="/assets/js/71.38f9fa21.js"><link rel="prefetch" href="/assets/js/72.0b43d0ef.js"><link rel="prefetch" href="/assets/js/73.f27252fd.js"><link rel="prefetch" href="/assets/js/74.5dccc453.js"><link rel="prefetch" href="/assets/js/75.ed796fa2.js"><link rel="prefetch" href="/assets/js/76.a5db5590.js"><link rel="prefetch" href="/assets/js/77.772277dc.js"><link rel="prefetch" href="/assets/js/78.a5c6c3d5.js"><link rel="prefetch" href="/assets/js/79.f3f60dbf.js"><link rel="prefetch" href="/assets/js/8.3eef07a9.js"><link rel="prefetch" href="/assets/js/80.52fe4d32.js"><link rel="prefetch" href="/assets/js/81.ce3ff02a.js"><link rel="prefetch" href="/assets/js/82.35424ee2.js"><link rel="prefetch" href="/assets/js/83.f9029fda.js"><link rel="prefetch" href="/assets/js/84.21b21f03.js"><link rel="prefetch" href="/assets/js/85.7453e07c.js"><link rel="prefetch" href="/assets/js/86.4924e795.js"><link rel="prefetch" href="/assets/js/87.600b7901.js"><link rel="prefetch" href="/assets/js/88.8afc3341.js"><link rel="prefetch" href="/assets/js/89.121a73bd.js"><link rel="prefetch" href="/assets/js/9.440a3591.js"><link rel="prefetch" href="/assets/js/90.d80142cf.js"><link rel="prefetch" href="/assets/js/91.10290169.js"><link rel="prefetch" href="/assets/js/92.19f19216.js"><link rel="prefetch" href="/assets/js/93.e21b64a3.js"><link rel="prefetch" href="/assets/js/94.afcb5ab9.js"><link rel="prefetch" href="/assets/js/95.0692127b.js"><link rel="prefetch" href="/assets/js/96.c3aaf90a.js"><link rel="prefetch" href="/assets/js/97.b8d368f1.js"><link rel="prefetch" href="/assets/js/98.ff43c32b.js"><link rel="prefetch" href="/assets/js/99.2a811a90.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a21ae05c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DILOMEN'S BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          综合
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/前端/HTML/" class="nav-link">
  HTML
</a></li><li class="dropdown-subitem"><a href="/前端/CSS/水平垂直居中.html" class="nav-link">
  CSS
</a></li></ul></li><li class="dropdown-item"><h4>
          编程语言
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/编程语言/JavaScript/基本类型和引用类型.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/编程语言/TypeScript/基础知识.html" class="nav-link">
  TypeScript
</a></li></ul></li><li class="dropdown-item"><h4>
          框架 | 库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/框架、库/React/生命周期.html" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/框架、库/Vue/生命周期.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/工程化/包管理/npm.html" class="nav-link">
  包管理
</a></li><li class="dropdown-item"><!----> <a href="/工程化/打包工具/webpack/基本配置.html" class="nav-link">
  打包工具
</a></li><li class="dropdown-item"><!----> <a href="/工程化/单元测试/Jest/基本知识.html" class="nav-link">
  单元测试
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码分析" class="dropdown-title"><span class="title">源码分析</span> <span class="arrow down"></span></button> <button type="button" aria-label="源码分析" class="mobile-dropdown-title"><span class="title">源码分析</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/源码分析/vue/运行机制.html" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/axios/axios源码分析.html" class="nav-link">
  axios
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/react/Component.html" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/antd/form.html" class="nav-link">
  antd
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/react-router/" class="nav-link">
  react-router
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/vue-router/基本知识.html" class="nav-link">
  vue-router
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机通用" class="dropdown-title"><span class="title">计算机通用</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机通用" class="mobile-dropdown-title"><span class="title">计算机通用</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/计算机通用/计算机基础/数据结构.html" class="nav-link">
  计算机基础
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/设计模式/设计模式介绍.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/web安全/web安全简述.html" class="nav-link">
  web安全
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/算法/排序.html" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/浏览器/浏览器缓存机制.html" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/网络/常见的状态码.html" class="nav-link">
  网络
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="拓展学习" class="dropdown-title"><span class="title">拓展学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="拓展学习" class="mobile-dropdown-title"><span class="title">拓展学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/拓展学习/Java/基础知识.html" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/拓展学习/技术了解/Redis.html" class="nav-link">
  技术了解
</a></li><li class="dropdown-item"><!----> <a href="/拓展学习/技术杂谈/关于重构的那点事.html" class="nav-link">
  技术杂谈
</a></li><li class="dropdown-item"><!----> <a href="/拓展学习/Node/基础知识/基础知识.html" class="nav-link">
  Node
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/Dilomen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          综合
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/前端/HTML/" class="nav-link">
  HTML
</a></li><li class="dropdown-subitem"><a href="/前端/CSS/水平垂直居中.html" class="nav-link">
  CSS
</a></li></ul></li><li class="dropdown-item"><h4>
          编程语言
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/编程语言/JavaScript/基本类型和引用类型.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-subitem"><a href="/编程语言/TypeScript/基础知识.html" class="nav-link">
  TypeScript
</a></li></ul></li><li class="dropdown-item"><h4>
          框架 | 库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/框架、库/React/生命周期.html" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/框架、库/Vue/生命周期.html" class="nav-link">
  Vue
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工程化" class="dropdown-title"><span class="title">工程化</span> <span class="arrow down"></span></button> <button type="button" aria-label="工程化" class="mobile-dropdown-title"><span class="title">工程化</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/工程化/包管理/npm.html" class="nav-link">
  包管理
</a></li><li class="dropdown-item"><!----> <a href="/工程化/打包工具/webpack/基本配置.html" class="nav-link">
  打包工具
</a></li><li class="dropdown-item"><!----> <a href="/工程化/单元测试/Jest/基本知识.html" class="nav-link">
  单元测试
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码分析" class="dropdown-title"><span class="title">源码分析</span> <span class="arrow down"></span></button> <button type="button" aria-label="源码分析" class="mobile-dropdown-title"><span class="title">源码分析</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/源码分析/vue/运行机制.html" class="nav-link">
  vue
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/axios/axios源码分析.html" class="nav-link">
  axios
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/react/Component.html" class="nav-link">
  react
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/antd/form.html" class="nav-link">
  antd
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/react-router/" class="nav-link">
  react-router
</a></li><li class="dropdown-item"><!----> <a href="/源码分析/vue-router/基本知识.html" class="nav-link">
  vue-router
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机通用" class="dropdown-title"><span class="title">计算机通用</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机通用" class="mobile-dropdown-title"><span class="title">计算机通用</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/计算机通用/计算机基础/数据结构.html" class="nav-link">
  计算机基础
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/设计模式/设计模式介绍.html" class="nav-link">
  设计模式
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/web安全/web安全简述.html" class="nav-link">
  web安全
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/算法/排序.html" class="nav-link">
  算法
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/浏览器/浏览器缓存机制.html" class="nav-link">
  浏览器
</a></li><li class="dropdown-item"><!----> <a href="/计算机通用/网络/常见的状态码.html" class="nav-link">
  网络
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="拓展学习" class="dropdown-title"><span class="title">拓展学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="拓展学习" class="mobile-dropdown-title"><span class="title">拓展学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/拓展学习/Java/基础知识.html" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/拓展学习/技术了解/Redis.html" class="nav-link">
  技术了解
</a></li><li class="dropdown-item"><!----> <a href="/拓展学习/技术杂谈/关于重构的那点事.html" class="nav-link">
  技术杂谈
</a></li><li class="dropdown-item"><!----> <a href="/拓展学习/Node/基础知识/基础知识.html" class="nav-link">
  Node
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/Dilomen" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/源码分析/vue/运行机制.html" class="sidebar-link">运行机制</a></li><li><a href="/源码分析/vue/响应式.html" class="sidebar-link">响应式</a></li><li><a href="/源码分析/vue/模板编译.html" class="active sidebar-link">模板编译</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#执行位置" class="sidebar-link">执行位置</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#生成-ast" class="sidebar-link">生成 AST</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#parsehtml" class="sidebar-link">parseHTML</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#注释节点" class="sidebar-link">注释节点</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#开始元素标签" class="sidebar-link">开始元素标签</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#结束元素标签" class="sidebar-link">结束元素标签</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#文本节点" class="sidebar-link">文本节点</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#监听方法" class="sidebar-link">监听方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#优化代码" class="sidebar-link">优化代码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#markstatic" class="sidebar-link">markStatic</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#markstaticroots" class="sidebar-link">markStaticRoots</a></li></ul></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#生成代码" class="sidebar-link">生成代码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#genelement" class="sidebar-link">genElement</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#genstatic" class="sidebar-link">genStatic</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#genchildren" class="sidebar-link">genChildren</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#gennode" class="sidebar-link">genNode</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#gendata" class="sidebar-link">genData</a></li></ul></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#vue-loader" class="sidebar-link">vue-loader</a></li><li class="sidebar-sub-header"><a href="/源码分析/vue/模板编译.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/源码分析/vue/VitualDOM.html" class="sidebar-link">VitualDOM</a></li><li><a href="/源码分析/vue/生命周期.html" class="sidebar-link">生命周期</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>axios</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react-router</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue-router</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>antd</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>Vue 的模板写法一向是其的特色，其极大的方便开发者平缓的学习路线，不需要学习类似 JSX 等语法。同样的模板编译也是 Vue 做提升性能的很大的一块内容，所以了解其内部的解析，能让我们更加的了解 Vue 的本质。</p> <p>首先在执行运行机制篇章，有讲到运行版和完整版，两者的区别就是打包的 vue 文件是否有当前篇章的内容——模板编译。当然这里的模板编译只讲 vue 中的编译实现，也就是完整版中的模板实现原理，至于运行版依赖的 vue-loader 中的模板实现，不在本篇章的范围内，所以不再具体展开。</p> <p>但是还是需要提到和本文相关的 vue-loader 部分，具体详情请看下面的 vue-loader</p> <h2 id="执行位置"><a href="#执行位置" class="header-anchor">#</a> 执行位置</h2> <p>既然是完整版，那么就从完整版入口文件开始查看，可以在挂载阶段前生成 render 函数的源码中找到</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// vue/src/platforms/web/entry-runtime-with-compiler.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> compileToFunctions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./compiler/index'</span><span class="token punctuation">;</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span> hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// vue/src/platforms/web/compiler/index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createCompiler <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'compiler/index'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> compile<span class="token punctuation">,</span> compileToFunctions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createCompiler</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>然后再从以上代码信息，我们最终追溯到了 createCompiler 方法，是的这个方法包含了整个编译模板的操作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/compiler/index.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> CompiledResult <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    ast<span class="token punctuation">,</span>
    render<span class="token operator">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
    staticRenderFns<span class="token operator">:</span> code<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>传入了一个模板以及相关配置，然后根据模板内容生成 ast</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果开启了 optimize 属性，那么就需要进行优化代码性能操作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>最终根据模板内容和配置生成代码，导出一份是静态 render 函数集合（就是没有动态数据的节点），一份是 render 函数，以及 ast</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">{</span>
  ast<span class="token punctuation">,</span>
  render<span class="token operator">:</span> code<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
  staticRenderFns<span class="token operator">:</span> code<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">staticRenderFns 是什么</p> <p>staticRenderFns 是什么就是将没有动态数据的节点都存到这个数组中</p> <p>这里生成的代码 code 是渲染函数 render 以及静态渲染函数 staticRenderFns(如果全是 HTML 静态节点就生成 staticRenderFns)</p> <p>比如以下的模板，span 节点从开始到结束都没有动态的数据，那么这一段就会被添加到 staticRenderFns，而有动态的 div 节点就不会</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span>
  <span class="token punctuation">&gt;</span></span>{{ msg }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><a data-fancybox="" title="生成render" href="/源码/vue源码/模板编译/生成render.png"><img src="/%E6%BA%90%E7%A0%81/vue%E6%BA%90%E7%A0%81/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/%E7%94%9F%E6%88%90render.png" alt="生成render"></a></p> <p>具体静态节点是如何加入 staticRenderFns 及使用的，请看下面的详情 genStatic 方法</p></div> <p>那么我们就根据上面的 3 个步骤开展源码的解析</p> <h2 id="生成-ast"><a href="#生成-ast" class="header-anchor">#</a> 生成 AST</h2> <p>首先从 parse 中可以看出主要是执行了 parseHTML 的方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// vue/src/compiler/parser/index.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parse</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> root
  <span class="token comment">// ...</span>
  <span class="token function">parseHTML</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">return</span> root
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="parsehtml"><a href="#parsehtml" class="header-anchor">#</a> parseHTML</h3> <p>可以看出 parseHTML 主要是对整个模板字符串进行 while 循环，一段一段的通过正则匹配来确定是什么节点元素</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="注释节点"><a href="#注释节点" class="header-anchor">#</a> 注释节点</h3> <p>如果第一个字符是&lt;并且匹配注释的正则，那么该节点就是注释节点，然后找到注释节点结尾的位置，就是匹配到--&gt;的位置<br>
如果需要保留注释，那么就调用传入的 comment 方法（具体看下面的监听方法知识部分），将整段注释作为参数<br>
然后在将游标指向注释节点的后面，即已经被分析过的部分就被截取掉了</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Comment:</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> commentEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'--&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>commentEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>shouldKeepComment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span>
          html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> commentEnd<span class="token punctuation">)</span><span class="token punctuation">,</span>
          index<span class="token punctuation">,</span>
          index <span class="token operator">+</span> commentEnd <span class="token operator">+</span> <span class="token number">3</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>commentEnd <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">截取方法 advance</p> <p>就是将 indexindex 是作为游标，从零开始向后移动，指向字符串的当前位置，即去掉已经分析过的模板字符串内容</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  index <span class="token operator">+=</span> n<span class="token punctuation">;</span>
  html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div> <p>如果配置到 conditionalComment 的正则，那就是条件注释，如&lt;![ IE ]&gt;等，同样也将其截取，然后进行下面的模板分析</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> conditionalComment <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!\[</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> conditionalEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">']&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">advance</span><span class="token punctuation">(</span>conditionalEnd <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">continue</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>如果匹配到了 doctype 的正则，那就是文档节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> doctype <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!DOCTYPE [^&gt;]+&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">;</span>
<span class="token comment">// Doctype:</span>
<span class="token keyword">const</span> doctypeMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>doctype<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">advance</span><span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="开始元素标签"><a href="#开始元素标签" class="header-anchor">#</a> 开始元素标签</h3> <p>虽然按源码顺序是先看结束元素标签，但是如果先讲开始元素标签才是正确顺序，毕竟有开始才有结束</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Start tag:</span>
<span class="token keyword">const</span> startTagMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">handleStartTag</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldIgnoreFirstNewline</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">advance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>首先会执行 parseStartTag 方法，该方法主要是看能不能根据正则匹配到开始标签，然后返回开始标签，包含标签名，开始结束位置，属性，<em>是否是自闭合标签</em></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> startTagMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[a-zA-Z_][\\-\\.0-9_a-zA-Z]*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\:)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> startTagOpen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*(\/?)&gt;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// console.log(`&lt;Button&gt;Hello World&lt;/Button&gt;`.match(startTagOpen))</span>
  <span class="token comment">// [&quot;&lt;Button&quot;, &quot;Button&quot;, index: 0, input: &quot;&lt;Button&gt;Hello World&lt;/Button&gt;&quot;, groups: undefined]</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token punctuation">{</span>
      tagName<span class="token operator">:</span> start<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      attrs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      start<span class="token operator">:</span> index<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> end<span class="token punctuation">,</span> attr<span class="token punctuation">;</span>
    <span class="token comment">// 如果没有匹配到结束标识，并匹配到属性的话，就开始添加记录attrs属性</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token punctuation">(</span>end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>dynamicArgAttribute<span class="token punctuation">)</span> <span class="token operator">||</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      attr<span class="token punctuation">.</span>start <span class="token operator">=</span> index<span class="token punctuation">;</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      attr<span class="token punctuation">.</span>end <span class="token operator">=</span> index<span class="token punctuation">;</span>
      match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 根据正则匹配，如果是自闭合元素end[1]就是'/'，如果不是就是''，以此来判断是否是自闭合元素</span>
    <span class="token comment">// console.log('&gt;'.match(startTagClose))  // [&quot;&gt;&quot;, &quot;&quot;, index: 0, input: &quot;&gt;&quot;, groups: undefined]</span>
    <span class="token comment">// console.log('/&gt;'.match(startTagClose))  // [&quot;/&gt;&quot;, &quot;/&quot;, index: 0, input: &quot;/&gt;&quot;, groups: undefined]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      match<span class="token punctuation">.</span>unarySlash <span class="token operator">=</span> end<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      match<span class="token punctuation">.</span>end <span class="token operator">=</span> index<span class="token punctuation">;</span>
      <span class="token keyword">return</span> match<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="handlestarttag"><a href="#handlestarttag" class="header-anchor">#</a> handleStartTag</h4> <p>如果 parseStartTag 返回由内容，就说明确实是开始标签元素，那么就执行 handleStartTag 方法</p> <p>首先先看返回的结构例子，也就是 handleStartTag 的实参</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>match<span class="token operator">:</span> <span class="token punctuation">{</span>
  tagName<span class="token operator">:</span> Button<span class="token punctuation">,</span>
  attrs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;class=&quot;</span>a<span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> index<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> input<span class="token operator">:</span> <span class="token string">&quot;class=&quot;</span>a<span class="token string">&quot;&gt;Hello World&lt;/button&gt;&quot;</span><span class="token punctuation">,</span> groups<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">27</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  start<span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span>
  end<span class="token operator">:</span> <span class="token number">26</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>有代码可见，主要是对属性进行了包装，以及加入了“标签栈”，直至找到对应的结束标签才能出栈，这样也能保证父子标签的嵌套关系，最后调用 start 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleStartTag</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tagName <span class="token operator">=</span> match<span class="token punctuation">.</span>tagName<span class="token punctuation">;</span>
  <span class="token keyword">const</span> unarySlash <span class="token operator">=</span> match<span class="token punctuation">.</span>unarySlash<span class="token punctuation">;</span>

  <span class="token keyword">const</span> unary <span class="token operator">=</span> <span class="token function">isUnaryTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>unarySlash<span class="token punctuation">;</span>

  <span class="token keyword">const</span> l <span class="token operator">=</span> match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">const</span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token function">decodeAttr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> shouldDecodeNewlines<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果不是自闭合标签，就将该元素标签入栈，直至找到对应的结束标签，才能出栈</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>unary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      tag<span class="token operator">:</span> tagName<span class="token punctuation">,</span>
      lowerCasedTag<span class="token operator">:</span> tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      attrs<span class="token operator">:</span> attrs<span class="token punctuation">,</span>
      start<span class="token operator">:</span> match<span class="token punctuation">.</span>start<span class="token punctuation">,</span>
      end<span class="token operator">:</span> match<span class="token punctuation">.</span>end<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lastTag <span class="token operator">=</span> tagName<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 调用start监听函数，创建标签AST</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> match<span class="token punctuation">.</span>start<span class="token punctuation">,</span> match<span class="token punctuation">.</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="结束元素标签"><a href="#结束元素标签" class="header-anchor">#</a> 结束元素标签</h3> <p>首先也是根据结束的正则来进行 match 匹配，来获取元素名称，然后调用了 parseEndTag 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[a-zA-Z_][\\-\\.0-9_a-zA-Z]*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\:)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;\\/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[^&gt;]*&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token comment">// End tag:</span>
      <span class="token keyword">const</span> endTagMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>endTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> curIndex <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">parseEndTag</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> curIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>测试</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;/Button&gt;Hello World&lt;/Button&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">&quot;&lt;/Button&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Button&quot;</span><span class="token punctuation">,</span> index<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> input<span class="token operator">:</span> <span class="token string">&quot;&lt;/Button&gt;Hello World&lt;/Button&gt;&quot;</span><span class="token punctuation">,</span> groups<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="parseendtag"><a href="#parseendtag" class="header-anchor">#</a> parseEndTag</h4> <p>首先会将标签变成小写，然后在之前开始标签的加入的“标签栈”中找到对应的开始标签，这样就有始有终，表示一个完整的标签内容，那么在栈中，开始标签和结束标签之间的都会被作为完整的标签，所以会循环，调用 end 监听方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseEndTag</span><span class="token punctuation">(</span><span class="token parameter">tagName<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pos<span class="token punctuation">,</span> lowerCasedTagName<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> start <span class="token operator">=</span> index<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> end <span class="token operator">=</span> index<span class="token punctuation">;</span>

  <span class="token comment">// Find the closest opened tag of the same type</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lowerCasedTagName <span class="token operator">=</span> tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>pos <span class="token operator">=</span> stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> pos <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> pos<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stack<span class="token punctuation">[</span>pos<span class="token punctuation">]</span><span class="token punctuation">.</span>lowerCasedTag <span class="token operator">===</span> lowerCasedTagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// If no tag name is provided, clean shop</span>
    pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Close all the open elements, up the stack</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> pos<span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 出栈，每一项调用end监听方法</span>
        options<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>stack<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 通过length的设置，将栈中完整的标签都移除了，即将栈指针指向匹配到的开始标签之前</span>
    stack<span class="token punctuation">.</span>length <span class="token operator">=</span> pos<span class="token punctuation">;</span>
    lastTag <span class="token operator">=</span> pos <span class="token operator">&amp;&amp;</span> stack<span class="token punctuation">[</span>pos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>如果是&lt;/br&gt;和&lt;/p&gt;特殊标签，作为开始标签，即调用 start 监听方法，p 标签同时也要调用 end 监听方法</p> <ul><li>&lt;/br&gt;会被浏览器转化为&lt;br&gt;</li> <li>&lt;/p&gt;会被浏览器转化为&lt;p&gt;<p></p></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lowerCasedTagName <span class="token operator">===</span> <span class="token string">'br'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lowerCasedTagName <span class="token operator">===</span> <span class="token string">'p'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">&quot;/&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> index<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> input<span class="token operator">:</span> <span class="token string">&quot;/&gt;&quot;</span><span class="token punctuation">,</span> groups<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">层级关系</p> <p>我们可以观察到，在整个 html 字符串的解析中，有一个 stack 的变量，一旦遇到开始元素，就入栈操作，而遇到结束元素，就进行出栈操作，由此当包装一个 AST 节点时，可以根据当前 stack 栈的前一个子项来得知其父元素</p> <p>同时这种方式也能保证没有节点都有开始和结束，即便是自闭合元素，在匹配到/&gt;也会进行出栈操作，从而保证每个元素都是完整的，一旦有不完整的就可以进行警告提醒</p> <h4 id="示例实验"><a href="#示例实验" class="header-anchor">#</a> 示例实验</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span>ele<span class="token operator">-</span>button<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ele<span class="token operator">-</span>button<span class="token operator">&gt;</span><span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span><span class="token operator">&gt;</span><span class="token number">12345</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token comment">// ========&gt;</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token punctuation">{</span>
  attrsList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  attrsMap<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    attrsList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    attrsMap<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    parent<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> tag<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> attrsList<span class="token operator">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attrsMap<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> rawAttrsMap<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span><span class="token punctuation">,</span>
    plain<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    rawAttrsMap<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    start<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    tag<span class="token operator">:</span> <span class="token string">&quot;ele-button&quot;</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    attrsList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    attrsMap<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token number">55</span><span class="token punctuation">,</span>
    parent<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> tag<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> attrsList<span class="token operator">:</span> <span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attrsMap<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> rawAttrsMap<span class="token operator">:</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> …<span class="token punctuation">}</span><span class="token punctuation">,</span>
    plain<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    rawAttrsMap<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">class</span><span class="token operator">:</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">&quot;class&quot;</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">33</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">45</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    start<span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
    staticClass<span class="token operator">:</span> <span class="token string">&quot;&quot;</span>text<span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    tag<span class="token operator">:</span> <span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    length<span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  end<span class="token operator">:</span> <span class="token number">61</span>
  parent<span class="token operator">:</span> <span class="token keyword">undefined</span>
  plain<span class="token operator">:</span> <span class="token boolean">true</span>
  rawAttrsMap<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  start<span class="token operator">:</span> <span class="token number">0</span>
  tag<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span>
  type<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>可以看出，父元素使用了 children 属性包裹了子元素，子元素使用了 parent 指向了父元素</p></div> <h3 id="文本节点"><a href="#文本节点" class="header-anchor">#</a> 文本节点</h3> <p>如果第一个不是&lt;，并且字符串中前面几种情况都没有匹配到，那么就是文本节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 都没有匹配到</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> text<span class="token punctuation">,</span> rest<span class="token punctuation">,</span> next<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 当匹配的&lt;后面匹配不上结束标签、开始标签、注释节点、条件节点，那么它就是文本节点中的部分</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>endTag<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>startTagOpen<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>conditionalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查看之后时候还有&lt;，即获取整段文本的内容</span>
    next <span class="token operator">=</span> rest<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    textEnd <span class="token operator">+=</span> next<span class="token punctuation">;</span>
    rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  text <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> textEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 如果整个字符串匹配不到&lt;，那么整个字符串就是文本节点</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  text <span class="token operator">=</span> html<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 触发chars监听方法</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>chars <span class="token operator">&amp;&amp;</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> index <span class="token operator">-</span> text<span class="token punctuation">.</span>length<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>如果是 script,style,textarea 等标签</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  last <span class="token operator">=</span> html<span class="token punctuation">;</span>
  <span class="token comment">// export const isPlainTextElement = makeMap('script,style,textarea', true)</span>
  <span class="token comment">// 不是脚本script/样式style,textarea等标签</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastTag <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isPlainTextElement</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是脚本script/样式style,textarea等标签</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">const</span> rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reStackedTag<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">all<span class="token punctuation">,</span> text<span class="token punctuation">,</span> endTag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// script,style,textarea标签内的内容直接当做文本处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>chars<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    index <span class="token operator">+=</span> html<span class="token punctuation">.</span>length <span class="token operator">-</span> rest<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    html <span class="token operator">=</span> rest<span class="token punctuation">;</span>
    <span class="token function">parseEndTag</span><span class="token punctuation">(</span>stackedTag<span class="token punctuation">,</span> index <span class="token operator">-</span> endTagLength<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>如果整个下来，什么也没变，那么就将整个 html 作为文本处理</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>html <span class="token operator">===</span> last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  options<span class="token punctuation">.</span>chars <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="监听方法"><a href="#监听方法" class="header-anchor">#</a> 监听方法</h3> <p>上面各种匹配到相关的标签，就会调用监听方法，这些监听方法也是将 template 字符串转成 AST 的关键，分别对标签开始、标签结束、遇到文本节点、遇到注释节点等所做出不同的处理方式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/compiler/parser/index.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ASTElement <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 标签开始时调用</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 标签结束时调用</span>
    <span class="token function">end</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 遇到文本时调用</span>
    <span class="token function">chars</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token operator">:</span> string<span class="token punctuation">,</span> start<span class="token operator">:</span> number<span class="token punctuation">,</span> end<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 遇到注释时调用</span>
    <span class="token function">comment</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token operator">:</span> string<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="start"><a href="#start" class="header-anchor">#</a> start</h4> <p>根据开始标签调用，然后由相关参数信息获取来创建一个 AST 节点，并根据 AST 中的信息，来转化一些信息的标识，如是否带有 v-if，v-once，slot 等，并对这些特殊的指令或者属性进行转换成 AST 对象节点上的属性，从而方便后面的使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">start</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element<span class="token operator">:</span> ASTElement <span class="token operator">=</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> currentParent<span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment">// ASTElement</span>
<span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  tag<span class="token punctuation">,</span>
  attrsList<span class="token operator">:</span> attrs<span class="token punctuation">,</span>
  attrsMap<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  rawAttrsMap<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  parent<span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>对于一些特殊的属性或指令，如 v-for，v-if 进行值的正则匹配，如果没有匹配上，那么就说明值有问题，进行警告</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>inVPre<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">processRawAttrs</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>element<span class="token punctuation">.</span>processed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">processFor</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">processIf</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">processOnce</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果匹配上了那么就在 AST 节点上添加特别的属性，如 v-once 就是 once:true，v-for 就是 alias 和 for 属性
<a data-fancybox="" title="/源码/vue源码/模板编译/ast添加指令属性.png" href="/源码/vue源码/模板编译/ast添加指令属性.png"><img src="/%E6%BA%90%E7%A0%81/vue%E6%BA%90%E7%A0%81/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/ast%E6%B7%BB%E5%8A%A0%E6%8C%87%E4%BB%A4%E5%B1%9E%E6%80%A7.png" alt="/源码/vue源码/模板编译/ast添加指令属性.png"></a></p> <p>还有就是是否是自闭合节点</p> <ul><li>是：说明是不带子元素的，所以生成 AST 后，就可以退出“标签栈”了，</li> <li>不是：加入“标签栈”，等待相应的结束标签来匹配</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">start</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 是否是自动闭合的元素</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>unary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentParent <span class="token operator">=</span> element
    <span class="token comment">// 方便end函数调用的时候获取，并处理</span>
    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">closeElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="end"><a href="#end" class="header-anchor">#</a> end</h4> <p>当遇到结束标签的时候会调用，表示一个元素节点的关闭，完结，其主要是将“标签栈”回到上一个父节点<br>
[祖先元素,父元素,elementTag,elementTag 子元素] ==&gt; [祖先元素,父元素]<br>
该元素标签结束，也说明其子元素都结束了</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">end</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> stack<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
  stack<span class="token punctuation">.</span>length <span class="token operator">-=</span> <span class="token number">1</span>
  currentParent <span class="token operator">=</span> stack<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>outputSourceRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    element<span class="token punctuation">.</span>end <span class="token operator">=</span> end
  <span class="token punctuation">}</span>
  <span class="token function">closeElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="chars"><a href="#chars" class="header-anchor">#</a> chars</h4> <p>主要是当遇到文本节点的时候调用，根据是否带有动态变量来进行生成不同的 AST 节点</p> <p>有变量的动态文本: parseText:处理带有变量的文本，如果没有变量，即纯静态文本，则返回 undefined，由此来判断时候带有变量</p> <p>parseText 方法来获取动态变量信息，如果存在就会返回 expression 和 tokens 字段</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">chars</span> <span class="token punctuation">(</span><span class="token parameter">text<span class="token operator">:</span> string<span class="token punctuation">,</span> start<span class="token operator">:</span> number<span class="token punctuation">,</span> end<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inVPre <span class="token operator">&amp;&amp;</span> text <span class="token operator">!==</span> <span class="token string">' '</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>res <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> delimiters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    child <span class="token operator">=</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      expression<span class="token operator">:</span> res<span class="token punctuation">.</span>expression<span class="token punctuation">,</span>
      tokens<span class="token operator">:</span> res<span class="token punctuation">.</span>tokens<span class="token punctuation">,</span>
      text
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如以下的模板会得到以下动态信息</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>template<span class="token operator">:</span> <span class="token string">'&lt;div&gt;&lt;span&gt;2222{{ msg }}&lt;/span&gt;&lt;/div&gt;'</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><a data-fancybox="" title="/源码/vue源码/模板编译/获取文本节点的动态信息.png" href="/源码/vue源码/模板编译/获取文本节点的动态信息.png"><img src="/%E6%BA%90%E7%A0%81/vue%E6%BA%90%E7%A0%81/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/%E8%8E%B7%E5%8F%96%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%E7%9A%84%E5%8A%A8%E6%80%81%E4%BF%A1%E6%81%AF.png" alt="/源码/vue源码/模板编译/获取文本节点的动态信息.png"></a></p> <p>如果 parseText 没有返回，那么就是纯文本</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>child <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  text<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="parsetext"><a href="#parsetext" class="header-anchor">#</a> parseText</h4> <p>将文本中带有的动态变量进行包装处理</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/compiler/parser/text-parser.js</span>
<span class="token comment">/**
 * text 传入的文本字符串内容
 * 变量的符号定义，一般默认是是 {{ value }}，但是也可以设置自定义的如%value%等，那么delimiters就是['%', '%']
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseText</span><span class="token punctuation">(</span>
  <span class="token parameter">text<span class="token operator">:</span> string<span class="token punctuation">,</span>
  delimiters<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">,</span> string<span class="token punctuation">]</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> TextParseResult <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 匹配变量，如果有自定义的如%，就选择自定义的，没有就是默认的{{}}</span>
  <span class="token keyword">const</span> tagRE <span class="token operator">=</span> delimiters <span class="token operator">?</span> <span class="token function">buildRegex</span><span class="token punctuation">(</span>delimiters<span class="token punctuation">)</span> <span class="token operator">:</span> defaultTagRE<span class="token punctuation">;</span>
  <span class="token comment">// 如果没有匹配到，即是纯文本内容，那么就返回undefined</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tagRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> rawTokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token punctuation">(</span>tagRE<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> match<span class="token punctuation">,</span> index<span class="token punctuation">,</span> tokenValue<span class="token punctuation">;</span>
  <span class="token comment">// 获取到动态变量字符串的位置，一旦后面还有变量就继续，即处理所有的变量</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> tagRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    index <span class="token operator">=</span> match<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
    <span class="token comment">// 先添加变量字符串前的纯文本内容到rawTokens和tokens两个数组内</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tokenValue <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 然后将动态变量进行转化，tokens添加 _s({变量})， rawTokens添加 { '@binding': 变量 }</span>
    <span class="token keyword">const</span> exp <span class="token operator">=</span> <span class="token function">parseFilters</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_s(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'@binding'</span><span class="token operator">:</span> exp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lastIndex <span class="token operator">=</span> index <span class="token operator">+</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果后面还有内容，那就都是纯文本内容，直接加入到数组中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastIndex <span class="token operator">&lt;</span> text<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rawTokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tokenValue <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tokenValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 最终形成</span>
  <span class="token comment">// {</span>
  <span class="token comment">//   expression: `纯文本+${_s({变量})}+纯文本`,</span>
  <span class="token comment">//   tokens: ['纯文本', { '@binding': 变量 }, '纯文本']</span>
  <span class="token comment">// }</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    expression<span class="token operator">:</span> tokens<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tokens<span class="token operator">:</span> rawTokens<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">delimiters 的处理</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 如果自定义的符号delimiters中包含以下正则，即一些敏感符号就会被vue进行替换，以便不会出现内容上的混乱</span>
<span class="token keyword">const</span> regexEscapeRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[-.*+?^${}()|[\]\/\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> buildRegex <span class="token operator">=</span> <span class="token function">cached</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">delimiters</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> open <span class="token operator">=</span> delimiters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regexEscapeRE<span class="token punctuation">,</span> <span class="token string">'\\$&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> close <span class="token operator">=</span> delimiters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regexEscapeRE<span class="token punctuation">,</span> <span class="token string">'\\$&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>open <span class="token operator">+</span> <span class="token string">'((?:.|\\n)+?)'</span> <span class="token operator">+</span> close<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div> <h4 id="comment"><a href="#comment" class="header-anchor">#</a> comment</h4> <p>生成注释节点，注释节点和纯文本节点一样，只是多一个 isComment 的属性标识</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">comment</span> <span class="token punctuation">(</span><span class="token parameter">text<span class="token operator">:</span> string<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> child<span class="token operator">:</span> ASTText <span class="token operator">=</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    text<span class="token punctuation">,</span>
    isComment<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="优化代码"><a href="#优化代码" class="header-anchor">#</a> 优化代码</h2> <p>主要是对一些静态节点进行优化，通过检测节点，是静态节点的话就打上静态标签，以减少不必要的重新渲染</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/compiler/index.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> createCompiler <span class="token operator">=</span> <span class="token function">createCompilerCreator</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>
  <span class="token parameter">template<span class="token operator">:</span> string<span class="token punctuation">,</span>
  options<span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> CompiledResult <span class="token punctuation">{</span>
  <span class="token comment">// 模板转AST相关</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimize <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 优化代码是对处理后的AST节点进行优化</span>
    <span class="token function">optimize</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>以下就是优化的整个方法，一个是打上静态标记，一个是打上根静态标记</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// src/compiler/optimizer.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">optimize</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token operator">:</span> <span class="token operator">?</span>ASTElement<span class="token punctuation">,</span> options<span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  isStaticKey <span class="token operator">=</span> <span class="token function">genStaticKeysCached</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>staticKeys <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  isPlatformReservedTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isReservedTag <span class="token operator">||</span> no<span class="token punctuation">;</span>
  <span class="token function">markStatic</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>定义静态的属性，即 options.staticKeys（type,tag,attrsList,attrsMap,plain,parent,children,attrs,start,end,rawAttrsMap,自己配置的静态节点）等标签都是静态属性</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>isStaticKey <span class="token operator">=</span> <span class="token function">genStaticKeysCached</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>staticKeys <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="markstatic"><a href="#markstatic" class="header-anchor">#</a> markStatic</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">markStatic</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> ASTNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do not make component slot content static. this avoids</span>
    <span class="token comment">// 1. components not able to mutate slot nodes</span>
    <span class="token comment">// 2. static slot content fails for hot-reloading</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token string">'slot'</span> <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'inline-template'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> block <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">;</span>
        <span class="token function">markStatic</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>isStatic：判断当前节点是否是静态节点
1、如果是含有动态节点的文本，直接 false
2、如果是纯文本就是 true
3、如果是带有 v-pre 指令，或者（没有绑定变量，元素上没有如 v-if，v-for 等逻辑指令，不是组件，所有属性都是静态属性），返回 true</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果子节点，递归对子节点同样进行静态判定，如果一旦子节点不是静态的，那么父节点也不是静态的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>如果元素有 v-if 等条件判断，就需要对所有的条件子节点（v-if,v-else,v-else-if）等进行获取 block 信息然后静态判定，一旦有非静态节点，那么父节点也不是静态节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> block <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">;</span>
    <span class="token function">markStatic</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token punctuation">.</span>static<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="markstaticroots"><a href="#markstaticroots" class="header-anchor">#</a> markStaticRoots</h3> <p>首先如果是静态节点或者是有 v-once 的节点，那么添加一个 staticInFor 的属性为 isInFor</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">||</span> node<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>staticInFor <span class="token operator">=</span> isInFor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>isInFor 是指是否是 v-for 下的节点，只有当节点含有 v-for，那么它的子节点的 isInFor 才是 true</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isInFor <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>node<span class="token punctuation">.</span>for<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>成为一个根静态节点的要求
1、是静态节点
2、必须有子节点
3、子节点不能只是一个文本，不然优化的成本会大于收益</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
  node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span>
  node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span>
  <span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>同样的对子节点和带有 v-if 判断条件的 block 内容节点进行 markStaticRoots 递归操作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isInFor <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>node<span class="token punctuation">.</span>for<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> l <span class="token operator">=</span> node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ifConditions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>block<span class="token punctuation">,</span> isInFor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="生成代码"><a href="#生成代码" class="header-anchor">#</a> 生成代码</h2> <p>根据 AST 节点生成 render 代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">generate</span><span class="token punctuation">(</span>
  <span class="token parameter">ast<span class="token operator">:</span> ASTElement <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> CodegenResult <span class="token punctuation">{</span>
  <span class="token comment">// 根据配置生成基本的state对象</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodegenState</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> ast <span class="token operator">?</span> <span class="token function">genElement</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'_c(&quot;div&quot;)'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    render<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">with(this){return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    staticRenderFns<span class="token operator">:</span> state<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>先根据配置生成基本的 state 对象，就是一个初始化各种属性值，生成一个包含各种信息的对象，然后判断是否存在 ast 节点，存在的话就调用 genElement，不存在就生成创建一个空 div 元素的 render 函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CodegenState</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> ast <span class="token operator">?</span> <span class="token function">genElement</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">'_c(&quot;div&quot;)'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="genelement"><a href="#genelement" class="header-anchor">#</a> genElement</h3> <p>根据不同的元素属性类型，进行不同的处理，一旦对对应的处理过了，就会设置对应的 Processed 属性为 true，表示已被相关的处理。</p> <p>由于 AST（抽象语法树）本身就是一颗对象树，而且 vue 也规定必须唯一一个元素包裹，所以就可以从第一个节点进入，然后递归整棵 AST 树，就可以生成整个 render 函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genElement</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token operator">:</span> ASTElement<span class="token punctuation">,</span> state<span class="token operator">:</span> CodegenState</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>pre <span class="token operator">=</span> el<span class="token punctuation">.</span>pre <span class="token operator">||</span> el<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>pre<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 执行未被处理过的静态根节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>staticRoot <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>staticProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genStatic</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行未被处理过的有v-once的节点，只渲染一次的节点</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>once <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>onceProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genOnce</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行未被处理过的带有for属性的节点</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>forProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genFor</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行未被处理过的带有if属性的节点</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>ifProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genIf</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行未被处理过的不带slot属性的template标签</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'template'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>el<span class="token punctuation">.</span>slotTarget <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'void 0'</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理slot标签元素</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'slot'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genSlot</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// component or element</span>
    <span class="token keyword">let</span> code<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      code <span class="token operator">=</span> <span class="token function">genComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>component<span class="token punctuation">,</span> el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> data<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">.</span>plain <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>pre <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">maybeComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> <span class="token function">genData</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果该元素没有inline-template内联模板的属性，将对其子元素同样执行</span>
      <span class="token keyword">const</span> children <span class="token operator">=</span> el<span class="token punctuation">.</span>inlineTemplate <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 递归，以此将子节点由父节点包裹</span>
      code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        data <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// data</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        children <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// children</span>
      <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// module transforms</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      code <span class="token operator">=</span> state<span class="token punctuation">.</span>transforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> code<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span><span class="token operator">&gt;</span><span class="token number">12345</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token string">&quot;_c('p',{staticClass:&quot;</span>text<span class="token string">&quot;},[_v(&quot;</span><span class="token number">12345</span><span class="token string">&quot;)])&quot;</span>

<span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span>ele<span class="token operator">-</span>button<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ele<span class="token operator">-</span>button<span class="token operator">&gt;</span><span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span><span class="token operator">&gt;</span><span class="token number">12345</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token string">&quot;_c('div',[_c('ele-button'),_c('p',{staticClass:&quot;</span>text<span class="token string">&quot;},[_v(&quot;</span><span class="token number">12345</span><span class="token string">&quot;)])],1)&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>_字母的都是 render 相关的方法简写，具体参考 Virtual DOM 篇章</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>vm<span class="token punctuation">.</span><span class="token function-variable function">_c</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">installRenderHelpers</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span>_o <span class="token operator">=</span> markOnce<span class="token punctuation">;</span>
  target<span class="token punctuation">.</span>_n <span class="token operator">=</span> toNumber<span class="token punctuation">;</span>
  target<span class="token punctuation">.</span>_s <span class="token operator">=</span> toString<span class="token punctuation">;</span>
  target<span class="token punctuation">.</span>_v <span class="token operator">=</span> createTextVNode<span class="token punctuation">;</span>
  target<span class="token punctuation">.</span>_e <span class="token operator">=</span> createEmptyVNode<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></div> <h3 id="genstatic"><a href="#genstatic" class="header-anchor">#</a> genStatic</h3> <p>处理静态节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// hoist static sub-trees out</span>
<span class="token keyword">function</span> <span class="token function">genStatic</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token operator">:</span> ASTElement<span class="token punctuation">,</span> state<span class="token operator">:</span> CodegenState</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  el<span class="token punctuation">.</span>staticProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token comment">// Some elements (templates) need to behave differently inside of a v-pre</span>
  <span class="token comment">// node.  All pre nodes are static roots, so we can use this as a location to</span>
  <span class="token comment">// wrap a state change and reset it upon exiting the pre node.</span>
  <span class="token keyword">const</span> originalPreState <span class="token operator">=</span> state<span class="token punctuation">.</span>pre<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>pre <span class="token operator">=</span> el<span class="token punctuation">.</span>pre<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  state<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">with(this){return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>pre <span class="token operator">=</span> originalPreState<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_m(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
    el<span class="token punctuation">.</span>staticInFor <span class="token operator">?</span> <span class="token string">',true'</span> <span class="token operator">:</span> <span class="token string">''</span>
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>这里我们就可以知道 staticRenderFns 是做了什么，会将一些静态节点生成的 render 函数加入到 staticRenderFns，然后将当前静态节点在 staticRenderFns 的索引位置由_m(索引)包裹，那么当 render 函数执行的时候，遇到_m 就会根据索引值去 staticRenderFns 中寻找，其实就是哟中缓存机制</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>state<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">with(this){return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_m(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token punctuation">.</span>staticRenderFns<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  el<span class="token punctuation">.</span>staticInFor <span class="token operator">?</span> <span class="token string">',true'</span> <span class="token operator">:</span> <span class="token string">''</span>
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="genchildren"><a href="#genchildren" class="header-anchor">#</a> genChildren</h3> <p>对子节点进行递归操作</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genChildren</span> <span class="token punctuation">(</span>
  <span class="token parameter">el<span class="token operator">:</span> ASTElement<span class="token punctuation">,</span>
  state<span class="token operator">:</span> CodegenState<span class="token punctuation">,</span>
  checkSkip<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  altGenElement<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
  altGenNode<span class="token operator">?</span><span class="token operator">:</span> Function</span>
<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 对每个子节点进行处理</span>
    <span class="token keyword">const</span> gen <span class="token operator">=</span> altGenNode <span class="token operator">||</span> genNode
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=&gt;</span> <span class="token function">gen</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      normalizationType <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>normalizationType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span>
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="gennode"><a href="#gennode" class="header-anchor">#</a> genNode</h3> <p>对 3 种节点的处理：元素，注释，文本</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genNode</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token operator">:</span> ASTNode<span class="token punctuation">,</span> state<span class="token operator">:</span> CodegenState</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genElement</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>isComment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genComment</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genText</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>处理文本节点，判断是否带有动态变量的话</p> <ul><li>有：就取 expression，因为 expression 本身就是将动态数据+纯文本包装好的 render 函数 -没有：就是纯文本，就取字符串，使用_v 包裹</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genText</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token operator">:</span> ASTText <span class="token operator">|</span> ASTExpression</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token comment">// 如果带有动态变量的话，就取expression，如果是纯文本，就取字符串，使用_v包裹</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_v(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
    text<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span>
      <span class="token operator">?</span> text<span class="token punctuation">.</span>expression
      <span class="token operator">:</span> <span class="token function">transformSpecialNewlines</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>注释节点用_e 包裹，直接取注释节点的文本内容部分</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genComment</span><span class="token punctuation">(</span><span class="token parameter">comment<span class="token operator">:</span> ASTText</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_e(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="gendata"><a href="#gendata" class="header-anchor">#</a> genData</h3> <p>拼接元素所有的属性字符串</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genData</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token operator">:</span> ASTElement<span class="token punctuation">,</span> state<span class="token operator">:</span> CodegenState</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">'{'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dirs <span class="token operator">=</span> <span class="token function">genDirectives</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirs<span class="token punctuation">)</span> data <span class="token operator">+=</span> dirs <span class="token operator">+</span> <span class="token string">','</span><span class="token punctuation">;</span>

  <span class="token comment">// key</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">key:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ref</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ref:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>ref<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>refInFor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">refInFor:true,</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="vue-loader"><a href="#vue-loader" class="header-anchor">#</a> vue-loader</h2> <p>其实在调试的时候，我们会发现一个问题，就是在子组件mount的时候，options.render 都是已经有处理好的 render 函数了，那么这个是什么时候已经生成的呢。</p> <p>首先我们找到初始化传入的 options，发现 components 属性其实已经被处理好了，值已经是一个被包装好的对象，其内容就是子组件相关的信息</p> <p><img src="/%E6%BA%90%E7%A0%81/vue%E6%BA%90%E7%A0%81/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/init_options.png" alt="init_options"></p> <p>而且我们还能找到 render 函数，也是已经被处理好的了</p> <p><img src="/%E6%BA%90%E7%A0%81/vue%E6%BA%90%E7%A0%81/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/init_options_render_fn.png" alt="init_options_fn"></p> <p>点击[[FunctionLocation]]边上的地址就可以看到方法详情</p> <p><img src="/%E6%BA%90%E7%A0%81/vue%E6%BA%90%E7%A0%81/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/init_options_render_fn_1.png" alt="init_options_fn"></p> <p>这个时候，就有一个想法涌上心头，是不是 import 导入的时候就已经处理好了！！！而处理模块化，完全是交付给了 webpack 下配置的 vue-loader，所以我们就去 vue-loader 中寻找答案</p> <p>该方法就是当遇到.vue 文件的时候处理的 loader 逻辑</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// vue-loader/lib/loaders/templateLoader.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">compileTemplate</span><span class="token punctuation">(</span>finalOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> compiled<span class="token punctuation">;</span>
  <span class="token comment">// finish with ESM exports</span>
  <span class="token keyword">return</span> code <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\nexport { render, staticRenderFns }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>输出的例子</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> _vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> _h <span class="token operator">=</span> _vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">;</span>
  <span class="token keyword">var</span> _c <span class="token operator">=</span> _vm<span class="token punctuation">.</span>_self<span class="token punctuation">.</span>_c <span class="token operator">||</span> _h<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> attrs<span class="token operator">:</span> <span class="token punctuation">{</span> ok<span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> _vm<span class="token punctuation">.</span>$style<span class="token punctuation">.</span>red <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>_vm<span class="token punctuation">.</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> staticRenderFns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
render<span class="token punctuation">.</span>_withStripped <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>由此，我们可以知道 vue-loader 已经将 template 中 import 导入的组件转化处理成了 render 函数，因此我们可以直接从options中获取（具体可以查看Virtual DOM篇章，子组件Ctor是如何继承，然后将属性都赋值到options 的）</p> <p>所以说 vue 自带的模板编译只处理 main.js 下的模板，当然你也可以使用 Vue.components 等 API 创建组件，然后都写在一起，那么 vue 自带的编译模板才能起到它的作用，而一般开发的时候我们都使用模块化，子组件很多的模板编译部分其实都是 vue-loader 等提前处理好的，所以选择 vue 运行版优势就更大了，因为本身就是要利用 vue-loader 的，何不减小 vue 文件的体积！！！</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><a data-fancybox="" title="模板编译流程" href="/源码/vue源码/模板编译/模板编译流程.svg"><img src="/%E6%BA%90%E7%A0%81/vue%E6%BA%90%E7%A0%81/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91/%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B.svg" alt="模板编译流程"></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/源码分析/vue/响应式.html" class="prev">
        响应式
      </a></span> <span class="next"><a href="/源码分析/vue/VitualDOM.html">
        VitualDOM
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><div class="fixed" data-v-55c79701></div><div></div></div></div>
    <script src="/assets/js/app.42f00aa1.js" defer></script><script src="/assets/js/2.edb9f13a.js" defer></script><script src="/assets/js/102.6d1fffe1.js" defer></script><script src="/assets/js/3.61a7e294.js" defer></script>
  </body>
</html>
